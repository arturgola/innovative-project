# ğŸ”„ EcoScan - Data Flow Diagrams

## ğŸ“‹ Table of Contents

- [Overview](#overview)
- [Product Scanning Data Flow](#product-scanning-data-flow)
- [User Authentication Flow](#user-authentication-flow)
- [Scan History Retrieval Flow](#scan-history-retrieval-flow)
- [HSY Cache Management Flow](#hsy-cache-management-flow)
- [User Profile Update Flow](#user-profile-update-flow)
- [Error Handling Flows](#error-handling-flows)

---

## ğŸ“ Overview

This document provides detailed data flow diagrams for all major operations in the EcoScan application. Each diagram shows the exact path data takes through the system, including API calls, transformations, and database operations.

---

## ğŸ“¸ Product Scanning Data Flow

### Complete Scanning Pipeline

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MOBILE APP (Frontend)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1: USER INTERACTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User taps        â”‚
â”‚ "Scan Product"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Open Camera      â”‚
â”‚ (Expo Camera)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Capture Photo    â”‚
â”‚ â†’ imageUri       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 2: DATA PREPARATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create FormData                     â”‚
â”‚ {                                   â”‚
â”‚   image: {                          â”‚
â”‚     uri: 'file:///path/image.jpg',  â”‚
â”‚     type: 'image/jpeg',             â”‚
â”‚     name: 'product-image.jpg'       â”‚
â”‚   },                                â”‚
â”‚   userId: 1                         â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 3: API CALL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /analyze-product               â”‚
â”‚ Content-Type: multipart/form-data   â”‚
â”‚ Body: FormData                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND SERVER                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: FILE UPLOAD HANDLING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Multer Middleware                   â”‚
â”‚ â€¢ Validate file (max 10MB)          â”‚
â”‚ â€¢ Generate filename:                â”‚
â”‚   timestamp-random.jpg              â”‚
â”‚ â€¢ Save to ./uploads/                â”‚
â”‚ â†’ req.file.path                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 5: HSY CACHE LOADING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getHSYWasteGuideList()                  â”‚
â”‚                                         â”‚
â”‚ Check cache:                            â”‚
â”‚ IF cache_age < 24 hours                 â”‚
â”‚   â†’ Return cached data (600+ items)     â”‚
â”‚ ELSE                                    â”‚
â”‚   â†’ Fetch from HSY API                  â”‚
â”‚   â†’ Paginate through all items          â”‚
â”‚   â†’ Cache for 24 hours                  â”‚
â”‚   â†’ Return data                         â”‚
â”‚                                         â”‚
â”‚ Result: hsyWasteGuideList[]             â”‚
â”‚ [                                       â”‚
â”‚   {id: "123", title: "Plastic bottles", â”‚
â”‚    synonyms: ["PET bottle", ...]},      â”‚
â”‚   ...                                   â”‚
â”‚ ]                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 6: OBJECT MATERIAL ANALYSIS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analyzeObjectMaterial(imagePath)        â”‚
â”‚                                         â”‚
â”‚ 1. Read image file                      â”‚
â”‚    â†’ Buffer                             â”‚
â”‚                                         â”‚
â”‚ 2. Convert to base64                    â”‚
â”‚    â†’ base64String                       â”‚
â”‚                                         â”‚
â”‚ 3. OpenAI API Call #1                   â”‚
â”‚    POST https://api.openai.com/v1/      â”‚
â”‚         chat/completions                â”‚
â”‚    {                                    â”‚
â”‚      model: "gpt-4o-mini",              â”‚
â”‚      messages: [{                       â”‚
â”‚        role: "user",                    â”‚
â”‚        content: [                       â”‚
â”‚          {type: "text",                 â”‚
â”‚           text: "Identify material"},   â”‚
â”‚          {type: "image_url",            â”‚
â”‚           image_url: "data:image..."}   â”‚
â”‚        ]                                â”‚
â”‚      }],                                â”‚
â”‚      max_tokens: 50                     â”‚
â”‚    }                                    â”‚
â”‚                                         â”‚
â”‚ 4. Extract response                     â”‚
â”‚    â†’ "plastic bottle"                   â”‚
â”‚                                         â”‚
â”‚ Result: objectMaterial                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 7: MAIN PRODUCT ANALYSIS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ analyzeProductImage(imagePath, hsyList)  â”‚
â”‚                                          â”‚
â”‚ 1. Convert image to base64               â”‚
â”‚    â†’ base64Image                         â”‚
â”‚                                          â”‚
â”‚ 2. Format HSY list for AI                â”‚
â”‚    hsyListFormatted = hsyList.map(       â”‚
â”‚      item => `ID: ${item.id},            â”‚
â”‚               Title: "${item.title}",    â”‚
â”‚               Synonyms: [...]`           â”‚
â”‚    ).join('\n')                          â”‚
â”‚    â†’ 600+ lines of waste guide data      â”‚
â”‚                                          â”‚
â”‚ 3. OpenAI API Call #2 (Main Analysis)    â”‚
â”‚    POST /chat/completions                â”‚
â”‚    Prompt: "Analyze image, return:       â”‚
â”‚             - Primary answer             â”‚
â”‚             - 4 Alternative answers"     â”‚
â”‚                                          â”‚
â”‚    Response Structure:                   â”‚
â”‚    {                                     â”‚
â”‚      primaryAnswer: {                    â”‚
â”‚        itemName: "Plastic Bottle",       â”‚
â”‚        material: "PET plastic",          â”‚
â”‚        brand: "Coca-Cola",               â”‚
â”‚        category: "Beverage Container",   â”‚
â”‚        sortingExplanation: "...",        â”‚
â”‚        confidence: 85,                   â”‚
â”‚        keywords: ["bottle", "plastic"]   â”‚
â”‚      },                                  â”‚
â”‚      alternativeAnswers: [               â”‚
â”‚        {itemName: "Glass Bottle",        â”‚
â”‚         material: "glass",               â”‚
â”‚         sortingExplanation: "...",       â”‚
â”‚         confidence: 60},                 â”‚
â”‚        ...3 more alternatives            â”‚
â”‚      ]                                   â”‚
â”‚    }                                     â”‚
â”‚                                          â”‚
â”‚ 4. Extract primary answer fields         â”‚
â”‚    â†’ name, brand, category,              â”‚
â”‚      material, confidence, etc.          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 8: HSY MATCHING FOR PRIMARY ANSWER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Find HSY Match (OpenAI Call #3)          â”‚
â”‚                                          â”‚
â”‚ Input:                                   â”‚
â”‚ â€¢ Product: "Plastic Bottle, PET,         â”‚
â”‚            Beverage Container"           â”‚
â”‚ â€¢ HSY List: formatted 600+ items         â”‚
â”‚                                          â”‚
â”‚ OpenAI Prompt:                           â”‚
â”‚ "Find best match in HSY waste guide      â”‚
â”‚  Strategy:                               â”‚
â”‚  1. Try exact match                      â”‚
â”‚  2. Fall back to material match"         â”‚
â”‚                                          â”‚
â”‚ Response:                                â”‚
â”‚ {                                        â”‚
â”‚   id: 123,                               â”‚
â”‚   reasoning: "Exact match: 'Plastic      â”‚
â”‚               bottles' in HSY database"  â”‚
â”‚ }                                        â”‚
â”‚                                          â”‚
â”‚ Result: hsyMatchId = 123                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 9: PROCESS ALTERNATIVE ANSWERS (Loop 4x)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FOR EACH alternative (4 iterations)      â”‚
â”‚                                          â”‚
â”‚ Alternative #1: "Glass Bottle"           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ OpenAI API Call #4                 â”‚   â”‚
â”‚ â”‚ Find HSY match for:                â”‚   â”‚
â”‚ â”‚ "Glass Bottle, glass"              â”‚   â”‚
â”‚ â”‚                                    â”‚   â”‚
â”‚ â”‚ Response: {id: 456, reasoning: ""} â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Fetch HSY Details                  â”‚   â”‚
â”‚ â”‚ GET /waste-pages/456?lang=en       â”‚   â”‚
â”‚ â”‚                                    â”‚   â”‚
â”‚ â”‚ Returns full waste guide data      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚ Alternative #2-4: Repeat process...      â”‚
â”‚ â†’ API Calls #5, #6, #7                   â”‚
â”‚                                          â”‚
â”‚ Result: alternativeAnswers[]             â”‚
â”‚ [                                        â”‚
â”‚   {                                      â”‚
â”‚     itemName: "Glass Bottle",            â”‚
â”‚     material: "glass",                   â”‚
â”‚     sortingExplanation: "...",           â”‚
â”‚     confidence: 60,                      â”‚
â”‚     hsyMatchId: 456,                     â”‚
â”‚     wasteGuideMatch: {                   â”‚
â”‚       id: "456",                         â”‚
â”‚       title: "Glass bottles",            â”‚
â”‚       wasteTypes: [...],                 â”‚
â”‚       recyclingMethods: [...]            â”‚
â”‚     }                                    â”‚
â”‚   },                                     â”‚
â”‚   ...3 more alternatives                 â”‚
â”‚ ]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 10: FETCH PRIMARY HSY DETAILS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF hsyMatchId exists (123)               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ getHSYWasteGuideDetails(123)       â”‚   â”‚
â”‚ â”‚                                    â”‚   â”‚
â”‚ â”‚ GET HSY API:                       â”‚   â”‚
â”‚ â”‚ /waste-pages/123?lang=en           â”‚   â”‚
â”‚ â”‚                                    â”‚   â”‚
â”‚ â”‚ Response:                          â”‚   â”‚
â”‚ â”‚ {                                  â”‚   â”‚
â”‚ â”‚   id: "123",                       â”‚   â”‚
â”‚ â”‚   title: "Plastic bottles",        â”‚   â”‚
â”‚ â”‚   synonyms: ["PET bottle", ...],   â”‚   â”‚
â”‚ â”‚   notes: "Rinse before recycling", â”‚   â”‚
â”‚ â”‚   wasteTypes: [                    â”‚   â”‚
â”‚ â”‚     {id: "plastic",                â”‚   â”‚
â”‚ â”‚      title: "Plastic recycling",   â”‚   â”‚
â”‚ â”‚      description: "...",           â”‚   â”‚
â”‚ â”‚      informationPageUrl: "..."}    â”‚   â”‚
â”‚ â”‚   ],                               â”‚   â”‚
â”‚ â”‚   recyclingMethods: [              â”‚   â”‚
â”‚ â”‚     {id: "recycling-bin",          â”‚   â”‚
â”‚ â”‚      title: "Recycling bin",       â”‚   â”‚
â”‚ â”‚      description: "...",           â”‚   â”‚
â”‚ â”‚      isFree: true,                 â”‚   â”‚
â”‚ â”‚      infoPageUrl: "..."}           â”‚   â”‚
â”‚ â”‚   ]                                â”‚   â”‚
â”‚ â”‚ }                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚ Result: wasteGuideDetails                â”‚
â”‚                                          â”‚
â”‚ ELSE (no HSY match)                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ getAIRecyclingAdvice()             â”‚   â”‚
â”‚ â”‚ (OpenAI Call #8)                   â”‚   â”‚
â”‚ â”‚                                    â”‚   â”‚
â”‚ â”‚ Prompt: "Generate recycling advice â”‚   â”‚
â”‚ â”‚          for: Plastic Bottle"      â”‚   â”‚
â”‚ â”‚                                    â”‚   â”‚
â”‚ â”‚ Response:                          â”‚   â”‚
â”‚ â”‚ {                                  â”‚   â”‚
â”‚ â”‚   recyclingAdvice: "...",          â”‚   â”‚
â”‚ â”‚   isDangerous: false,              â”‚   â”‚
â”‚ â”‚   dangerWarning: null,             â”‚   â”‚
â”‚ â”‚   generalTips: [...]               â”‚   â”‚
â”‚ â”‚ }                                  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚
â”‚ Result: aiRecyclingAdvice                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 11: CALCULATE POINTS & LEVEL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Points Calculation                       â”‚
â”‚                                          â”‚
â”‚ points = floor(confidence / 2)           â”‚
â”‚          + (hsyMatch ? 10 : 0)           â”‚
â”‚                                          â”‚
â”‚ Example:                                 â”‚
â”‚ confidence = 85                          â”‚
â”‚ hsyMatch = true                          â”‚
â”‚ points = floor(85/2) + 10                â”‚
â”‚        = 42 + 10                         â”‚
â”‚        = 52 points                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 12: SAVE TO DATABASE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT INTO product_scans                â”‚
â”‚                                          â”‚
â”‚ Data to save:                            â”‚
â”‚ {                                        â”‚
â”‚   user_id: 1,                            â”‚
â”‚   name: "Plastic Bottle",                â”‚
â”‚   brand: "Coca-Cola",                    â”‚
â”‚   category: "Beverage Container",        â”‚
â”‚   barcode: "camera-scanned",             â”‚
â”‚   points: 52,                            â”‚
â”‚   rating: 85,                            â”‚
â”‚   description: "plastic bottle - ...",   â”‚
â”‚   recyclability: "PET plastic",          â”‚
â”‚   suggestions: JSON["..."],              â”‚
â”‚   confidence: 85,                        â”‚
â”‚   analysis_method: "openai-vision-...",  â”‚
â”‚   object_material: "plastic bottle",     â”‚
â”‚   waste_guide_match: JSON{...},          â”‚
â”‚   ai_recycling_advice: null,             â”‚
â”‚   is_dangerous: 0,                       â”‚
â”‚   danger_warning: null,                  â”‚
â”‚   general_tips: null,                    â”‚
â”‚   alternative_answers: JSON[...],        â”‚
â”‚   image_path: "./uploads/...",           â”‚
â”‚   photo_width: 0,                        â”‚
â”‚   photo_height: 0,                       â”‚
â”‚   scanned_at: "2025-12-12T10:30:00Z"     â”‚
â”‚ }                                        â”‚
â”‚                                          â”‚
â”‚ â†’ Returns: insertId (e.g., 42)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 13: UPDATE USER STATS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IF userId provided (1)                   â”‚
â”‚                                          â”‚
â”‚ 1. Get current user stats                â”‚
â”‚    SELECT total_points FROM users        â”‚
â”‚    WHERE id = 1                          â”‚
â”‚    â†’ previousTotal = 400                 â”‚
â”‚                                          â”‚
â”‚ 2. Calculate new total                   â”‚
â”‚    newTotal = 400 + 52 = 452             â”‚
â”‚                                          â”‚
â”‚ 3. Calculate new level                   â”‚
â”‚    newLevel = floor(452 / 200) + 1       â”‚
â”‚            = floor(2.26) + 1             â”‚
â”‚            = 2 + 1 = 3                   â”‚
â”‚                                          â”‚
â”‚ 4. Update user record                    â”‚
â”‚    UPDATE users SET                      â”‚
â”‚      total_points = 452,                 â”‚
â”‚      level = 3,                          â”‚
â”‚      scans_today = scans_today + 1,      â”‚
â”‚      updated_at = CURRENT_TIMESTAMP      â”‚
â”‚    WHERE id = 1                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 14: BUILD RESPONSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Construct complete product object        â”‚
â”‚                                          â”‚
â”‚ {                                        â”‚
â”‚   id: 42,                                â”‚
â”‚   name: "Plastic Bottle",                â”‚
â”‚   brand: "Coca-Cola",                    â”‚
â”‚   category: "Beverage Container",        â”‚
â”‚   barcode: "camera-scanned",             â”‚
â”‚   points: 52,                            â”‚
â”‚   rating: 85,                            â”‚
â”‚   description: "plastic bottle - ...",   â”‚
â”‚   scannedAt: "2025-12-12T10:30:00Z",     â”‚
â”‚   photoUri: "/uploads/1733...-123.jpg",  â”‚
â”‚   photoWidth: 0,                         â”‚
â”‚   photoHeight: 0,                        â”‚
â”‚   recyclability: "PET plastic",          â”‚
â”‚   suggestions: [...],                    â”‚
â”‚   confidence: 85,                        â”‚
â”‚   analysisMethod: "openai-vision-...",   â”‚
â”‚   objectMaterial: "plastic bottle",      â”‚
â”‚   wasteGuideMatch: {                     â”‚
â”‚     id: "123",                           â”‚
â”‚     title: "Plastic bottles",            â”‚
â”‚     synonyms: [...],                     â”‚
â”‚     wasteTypes: [...],                   â”‚
â”‚     recyclingMethods: [...]              â”‚
â”‚   },                                     â”‚
â”‚   aiRecyclingAdvice: null,               â”‚
â”‚   alternativeAnswers: [                  â”‚
â”‚     {itemName: "Glass Bottle",           â”‚
â”‚      material: "glass",                  â”‚
â”‚      confidence: 60,                     â”‚
â”‚      hsyMatchId: 456,                    â”‚
â”‚      wasteGuideMatch: {...}},            â”‚
â”‚     ...3 more                            â”‚
â”‚   ]                                      â”‚
â”‚ }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 15: SEND HTTP RESPONSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP 200 OK                              â”‚
â”‚ Content-Type: application/json           â”‚
â”‚                                          â”‚
â”‚ Body: {product data from step 14}        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MOBILE APP (Frontend)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 16: FRONTEND PROCESSING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Receive response                         â”‚
â”‚                                          â”‚
â”‚ 1. Convert relative photoUri to absolute â”‚
â”‚    photoUri = API_BASE_URL + photoUri    â”‚
â”‚    â†’ "http://192.168.1.145:3000/..."     â”‚
â”‚                                          â”‚
â”‚ 2. Update app context                    â”‚
â”‚    setCurrentProduct(product)            â”‚
â”‚    addScannedProduct(product)            â”‚
â”‚                                          â”‚
â”‚ 3. Navigate to product details screen    â”‚
â”‚    router.push('/product')               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 17: DISPLAY RESULTS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Product Details Screen                   â”‚
â”‚                                          â”‚
â”‚ â€¢ Show product image                     â”‚
â”‚ â€¢ Display name, brand, category          â”‚
â”‚ â€¢ Show recycling instructions            â”‚
â”‚   (from HSY or AI advice)                â”‚
â”‚ â€¢ Display alternative interpretations    â”‚
â”‚ â€¢ Show points earned                     â”‚
â”‚ â€¢ Show confidence score                  â”‚
â”‚                                          â”‚
â”‚ â†’ Navigate to Success Screen             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“

Step 18: SUCCESS CONFIRMATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Success Screen                           â”‚
â”‚                                          â”‚
â”‚ â€¢ "Scan Complete!"                       â”‚
â”‚ â€¢ Points earned: +52                     â”‚
â”‚ â€¢ New level notification (if leveled up) â”‚
â”‚ â€¢ Button: "Scan Another"                 â”‚
â”‚ â€¢ Button: "View History"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Data Transformation Summary

```
Image File (Frontend)
    â†“
FormData (multipart/form-data)
    â†“
File Buffer (Backend)
    â†“
Base64 String
    â†“
OpenAI Vision API
    â†“
JSON Analysis Result
    â†“
HSY Matching (multiple AI calls)
    â†“
Complete Product Object
    â†“
Database Record (SQLite)
    â†“
JSON Response
    â†“
Frontend State Update
    â†“
UI Display
```

---

## ğŸ‘¤ User Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App Launch       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AppContext.useEffect()              â”‚
â”‚ â†’ loadOrCreateUser()                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /users                          â”‚
â”‚                                     â”‚
â”‚ Backend:                            â”‚
â”‚ SELECT * FROM users                 â”‚
â”‚ ORDER BY created_at DESC            â”‚
â”‚                                     â”‚
â”‚ Response: UserProfile[]             â”‚
â”‚ [                                   â”‚
â”‚   {id: 1, name: "EcoWarrior", ...}, â”‚
â”‚   {id: 2, name: "GreenHero", ...}   â”‚
â”‚ ]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Users.length?â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚   â”‚
    > 0  â”‚   â”‚ = 0
         â”‚   â”‚
         â†“   â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                   â”‚
    â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Load First â”‚   â”‚ Show Onboarding  â”‚
â”‚ User       â”‚   â”‚ Screen           â”‚
â”‚            â”‚   â”‚                  â”‚
â”‚ setUser    â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Profile    â”‚   â”‚ â”‚ Input Name   â”‚ â”‚
â”‚ (users[0]) â”‚   â”‚ â”‚ "EcoWarrior" â”‚ â”‚
â”‚            â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ setHasUser â”‚   â”‚        â”‚         â”‚
â”‚ (true)     â”‚   â”‚        â†“         â”‚
â”‚            â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ Navigate   â”‚   â”‚ â”‚ Submit       â”‚ â”‚
â”‚ to Menu    â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ POST /users     â”‚
                 â”‚                 â”‚
                 â”‚ Request:        â”‚
                 â”‚ {               â”‚
                 â”‚   name: "Eco...",â”‚
                 â”‚   level: 1,     â”‚
                 â”‚   total_points:0â”‚
                 â”‚ }               â”‚
                 â”‚                 â”‚
                 â”‚ Backend:        â”‚
                 â”‚ INSERT INTO     â”‚
                 â”‚ users (...)     â”‚
                 â”‚                 â”‚
                 â”‚ Response:       â”‚
                 â”‚ {id: 3, ...}    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ setUserProfile  â”‚
                 â”‚ (newUser)       â”‚
                 â”‚                 â”‚
                 â”‚ setHasUser      â”‚
                 â”‚ (true)          â”‚
                 â”‚                 â”‚
                 â”‚ Navigate to     â”‚
                 â”‚ Menu            â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Scan History Retrieval Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User taps        â”‚
â”‚ "View History"   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Navigate to Statistics Screen       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useEffect() â†’ fetchUserScans()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET /users/:id/scans                â”‚
â”‚                                     â”‚
â”‚ Backend:                            â”‚
â”‚ SELECT * FROM product_scans         â”‚
â”‚ WHERE user_id = 1                   â”‚
â”‚ ORDER BY created_at DESC            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transform Database Rows             â”‚
â”‚                                     â”‚
â”‚ FOR EACH row:                       â”‚
â”‚ {                                   â”‚
â”‚   id: row.id,                       â”‚
â”‚   name: row.name,                   â”‚
â”‚   points: row.points,               â”‚
â”‚   wasteGuideMatch:                  â”‚
â”‚     JSON.parse(row.waste_guide...),â”‚
â”‚   alternativeAnswers:               â”‚
â”‚     JSON.parse(row.alternative...),â”‚
â”‚   photoUri: `/uploads/${basename}`, â”‚
â”‚   ...                               â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP Response                       â”‚
â”‚ [                                   â”‚
â”‚   {scan1}, {scan2}, {scan3}, ...    â”‚
â”‚ ]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Processing                 â”‚
â”‚                                     â”‚
â”‚ Convert photoUri to absolute:       â”‚
â”‚ scans.map(scan => ({                â”‚
â”‚   ...scan,                          â”‚
â”‚   photoUri: API_BASE_URL + photoUri â”‚
â”‚ }))                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Display in UI                       â”‚
â”‚                                     â”‚
â”‚ â€¢ List of scanned products          â”‚
â”‚ â€¢ Product images                    â”‚
â”‚ â€¢ Points per scan                   â”‚
â”‚ â€¢ Total statistics                  â”‚
â”‚ â€¢ Tap to view details               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ HSY Cache Management Flow

### Initial Cache Load (On Server Start)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server Start     â”‚
â”‚ app.listen()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ initializeServer()                  â”‚
â”‚ â†’ getHSYWasteGuideList()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Cache Status                  â”‚
â”‚                                     â”‚
â”‚ IF hsyWasteGuideCache exists AND    â”‚
â”‚    (now - hsyCacheTimestamp)        â”‚
â”‚    < 24 hours                       â”‚
â”‚                                     â”‚
â”‚ THEN: Return cached data            â”‚
â”‚                                     â”‚
â”‚ ELSE: Fetch from HSY API â†“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HSY API Request                     â”‚
â”‚                                     â”‚
â”‚ GET https://dev.klapi.hsy.fi/       â”‚
â”‚     int2001/v1/waste-guide-api/     â”‚
â”‚     waste-pages?lang=en             â”‚
â”‚                                     â”‚
â”‚ Headers:                            â”‚
â”‚ {                                   â”‚
â”‚   Content-Type: application/json,   â”‚
â”‚   client_id: HSY_CLIENT_ID,         â”‚
â”‚   client_secret: HSY_CLIENT_SECRET  â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Receive First Page (20 items)      â”‚
â”‚                                     â”‚
â”‚ Response:                           â”‚
â”‚ {                                   â”‚
â”‚   total: 623,                       â”‚
â”‚   hits: [                           â”‚
â”‚     {id, title, synonyms}, ...      â”‚
â”‚   ]                                 â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pagination Detection                â”‚
â”‚                                     â”‚
â”‚ totalCount = 623                    â”‚
â”‚ itemsReceived = 20                  â”‚
â”‚ needMorePages = true                â”‚
â”‚                                     â”‚
â”‚ totalPages = ceil(623 / 20) = 32    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test Pagination Formats             â”‚
â”‚                                     â”‚
â”‚ Try multiple URL patterns:          â”‚
â”‚ 1. ?lang=en&page=2                  â”‚
â”‚ 2. ?lang=en&offset=40               â”‚
â”‚ 3. ?lang=en&from=40                 â”‚
â”‚ 4. ?lang=en&skip=40                 â”‚
â”‚ 5. ?lang=en&start=40                â”‚
â”‚                                     â”‚
â”‚ Test with page 2 to verify format   â”‚
â”‚                                     â”‚
â”‚ â†’ Working format found: &page=N     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fetch All Pages (Loop)              â”‚
â”‚                                     â”‚
â”‚ FOR page = 2 TO 32:                 â”‚
â”‚   GET .../waste-pages?lang=en       â”‚
â”‚       &page=${page}                 â”‚
â”‚                                     â”‚
â”‚   Response: {hits: [20 items]}      â”‚
â”‚                                     â”‚
â”‚   Filter duplicates (by ID)         â”‚
â”‚   Add to allWasteItems[]            â”‚
â”‚                                     â”‚
â”‚   Delay 100ms (API rate limit)      â”‚
â”‚                                     â”‚
â”‚   IF allItems.length >= 623         â”‚
â”‚     BREAK                           â”‚
â”‚   END IF                            â”‚
â”‚ END FOR                             â”‚
â”‚                                     â”‚
â”‚ Total fetched: 623 items            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Deduplication                       â”‚
â”‚                                     â”‚
â”‚ Remove duplicate IDs:               â”‚
â”‚ uniqueItems = items.filter(         â”‚
â”‚   (item, index, array) =>           â”‚
â”‚     array.findIndex(                â”‚
â”‚       other => other.id === item.id â”‚
â”‚     ) === index                     â”‚
â”‚ )                                   â”‚
â”‚                                     â”‚
â”‚ 623 items â†’ 623 unique items        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Simplify Data Structure             â”‚
â”‚                                     â”‚
â”‚ Extract only needed fields:         â”‚
â”‚ simplifiedItems = uniqueItems.map(  â”‚
â”‚   item => ({                        â”‚
â”‚     id: item.id,                    â”‚
â”‚     title: item.title,              â”‚
â”‚     synonyms: item.synonyms || []   â”‚
â”‚   })                                â”‚
â”‚ ).filter(                           â”‚
â”‚   item => item.title && item.id     â”‚
â”‚ )                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Cache                        â”‚
â”‚                                     â”‚
â”‚ hsyWasteGuideCache = simplifiedItemsâ”‚
â”‚ hsyCacheTimestamp = Date.now()      â”‚
â”‚                                     â”‚
â”‚ Cache valid for: 24 hours           â”‚
â”‚ Cache size: 623 items               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Return Cache                        â”‚
â”‚                                     â”‚
â”‚ â†’ Used by analyzeProductImage()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cache Refresh (24 Hours Later)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Call         â”‚
â”‚ /analyze-product â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getHSYWasteGuideList()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Cache Age                     â”‚
â”‚                                     â”‚
â”‚ now = Date.now()                    â”‚
â”‚ age = now - hsyCacheTimestamp       â”‚
â”‚                                     â”‚
â”‚ IF age < 24 hours (86400000 ms)     â”‚
â”‚   â†’ Return cached data              â”‚
â”‚                                     â”‚
â”‚ ELSE IF age >= 24 hours             â”‚
â”‚   â†’ Fetch fresh data (as above)     â”‚
â”‚   â†’ Update cache                    â”‚
â”‚   â†’ Return new data                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¤ User Profile Update Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User edits       â”‚
â”‚ profile          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Name, etc.                   â”‚
â”‚ Submit Form                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ApiService.updateUser()             â”‚
â”‚                                     â”‚
â”‚ PUT /users/:id                      â”‚
â”‚                                     â”‚
â”‚ Request:                            â”‚
â”‚ {                                   â”‚
â”‚   name: "Updated Name",             â”‚
â”‚   level: 4,                         â”‚
â”‚   total_points: 750                 â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend Processing                  â”‚
â”‚                                     â”‚
â”‚ 1. Validate name (not empty)        â”‚
â”‚                                     â”‚
â”‚ 2. Fetch current user               â”‚
â”‚    SELECT * FROM users WHERE id=1   â”‚
â”‚                                     â”‚
â”‚ 3. Merge updates with existing      â”‚
â”‚    newName = req.name || existing   â”‚
â”‚    newLevel = req.level || existing â”‚
â”‚    ...                              â”‚
â”‚                                     â”‚
â”‚ 4. Update database                  â”‚
â”‚    UPDATE users SET                 â”‚
â”‚      name = ?,                      â”‚
â”‚      level = ?,                     â”‚
â”‚      total_points = ?,              â”‚
â”‚      updated_at = CURRENT_TIMESTAMP â”‚
â”‚    WHERE id = ?                     â”‚
â”‚                                     â”‚
â”‚ 5. Fetch updated record             â”‚
â”‚    SELECT * FROM users WHERE id=1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP Response                       â”‚
â”‚                                     â”‚
â”‚ {                                   â”‚
â”‚   id: 1,                            â”‚
â”‚   name: "Updated Name",             â”‚
â”‚   level: 4,                         â”‚
â”‚   totalPoints: 750,                 â”‚
â”‚   scansToday: 5,                    â”‚
â”‚   joinedDate: "2025-12-01..."       â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Update                     â”‚
â”‚                                     â”‚
â”‚ setUserProfile(updatedUser)         â”‚
â”‚                                     â”‚
â”‚ UI automatically re-renders with    â”‚
â”‚ new data                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Error Handling Flows

### Image Analysis Error

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /analyze-   â”‚
â”‚ product          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI API Call Fails               â”‚
â”‚ (Network error, timeout, etc.)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Catch Error                         â”‚
â”‚                                     â”‚
â”‚ 1. Log error                        â”‚
â”‚    console.error(...)               â”‚
â”‚                                     â”‚
â”‚ 2. Clean up uploaded file           â”‚
â”‚    fs.unlink(req.file.path)         â”‚
â”‚                                     â”‚
â”‚ 3. Return fallback response         â”‚
â”‚    HTTP 500                         â”‚
â”‚    {                                â”‚
â”‚      error: "Analysis failed",      â”‚
â”‚      fallback: {                    â”‚
â”‚        id: Date.now(),              â”‚
â”‚        name: "Scanned Product",     â”‚
â”‚        brand: "Unknown",            â”‚
â”‚        category: "General Item",    â”‚
â”‚        points: random(10-60),       â”‚
â”‚        analysisMethod: "basic"      â”‚
â”‚      }                              â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Error Handling             â”‚
â”‚                                     â”‚
â”‚ IF response.error:                  â”‚
â”‚   Use fallback product              â”‚
â”‚   Show warning to user              â”‚
â”‚   Allow retry                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### HSY API Error

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ getHSYWasteGuide â”‚
â”‚ List()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HSY API Request Fails               â”‚
â”‚ (Auth error, network, timeout)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check for Stale Cache               â”‚
â”‚                                     â”‚
â”‚ IF hsyWasteGuideCache exists        â”‚
â”‚   â†’ Return stale cache data         â”‚
â”‚   â†’ Log warning                     â”‚
â”‚                                     â”‚
â”‚ ELSE                                â”‚
â”‚   â†’ Return empty array []           â”‚
â”‚   â†’ Product scan continues without  â”‚
â”‚       HSY matching                  â”‚
â”‚   â†’ AI recycling advice used        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Error

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT/UPDATE/   â”‚
â”‚ SELECT fails     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SQLite Error Callback               â”‚
â”‚                                     â”‚
â”‚ db.run(..., function(err) {         â”‚
â”‚   if (err) {                        â”‚
â”‚     console.error(err)              â”‚
â”‚     return res.status(500).json({   â”‚
â”‚       error: err.message            â”‚
â”‚     })                              â”‚
â”‚   }                                 â”‚
â”‚ })                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Error Display              â”‚
â”‚                                     â”‚
â”‚ catch (error) {                     â”‚
â”‚   console.error(error)              â”‚
â”‚   Alert.alert("Error", error.msg)   â”‚
â”‚ }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Size & Performance Metrics

### Typical Scan Data Sizes

```
Image Upload:
- Original Image: 2-5 MB (JPEG compressed)
- Base64 Encoded: ~4-7 MB (33% larger)

OpenAI API:
- Request Size: 4-7 MB (image) + 10-20 KB (prompt)
- Response Size: 1-3 KB (JSON)

HSY Cache:
- Memory Usage: ~100 KB (623 items simplified)
- Full Details: ~2 MB per item
- Network Transfer: ~10 MB (initial fetch all pages)

Database:
- Per Scan Record: ~5-10 KB (with JSON fields)
- Image File: 2-5 MB (stored on disk)

Total per Scan:
- Network: ~5-10 MB (upload + AI responses)
- Storage: ~2-5 MB (image + DB record)
- Memory: Minimal (streaming)
```

### API Call Timing

```
Typical Product Scan Pipeline:
1. Image Upload: 1-2 seconds
2. HSY Cache Load: <0.01s (cached) or 10-15s (fresh)
3. Object Material Analysis: 1-2 seconds
4. Main Analysis: 2-3 seconds
5. HSY Matching (Primary): 1-2 seconds
6. Alternatives Processing: 4-8 seconds (4 Ã— 1-2s)
7. Fetch HSY Details: 0.5-1 second
8. Database Save: <0.1 second

Total Time: 10-20 seconds per scan
```

---

**Last Updated:** December 12, 2025
